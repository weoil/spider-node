!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.spider=e():t.spider=e()}(global,function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=2)}([function(t,e,r){"use strict";var i=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))(function(n,s){function o(t){try{c(i.next(t))}catch(t){s(t)}}function u(t){try{c(i.throw(t))}catch(t){s(t)}}function c(t){t.done?n(t.value):new r(function(e){e(t.value)}).then(o,u)}c((i=i.apply(t,e||[])).next())})},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=n(r(1)),o=n(r(8));var u;!function(t){t[t.development=0]="development",t[t.production=1]="production",t[t.test=2]="test"}(u||(u={}));e.default=class{constructor(t,e){this.rules=[],this.mode=u.production,this.config=t,this.http=e?s.default.clone(e):new s.default(t.http,t.downloadMiddleware),this.initRules(t.rules),this.http.on("complete",this.handler.bind(this)),this.http.on("error",this.error.bind(this))}start(t,e){this.push(t,e)}dev(t,e){this.mode=u.test,this.start(t,e)}push(t,e={},r=!1){let i=[];Array.isArray(t)?i=i.concat(t):i.push(t),i.forEach(t=>{this.http.push(t,e,r)})}handler(t){return i(this,void 0,void 0,function*(){const{url:e,data:r,config:n}=t,s=[];for(const t of this.rules)t.test(e)&&s.push(t);let o=!0;s.forEach(t=>i(this,void 0,void 0,function*(){try{o&&(o=t.isInclude()),yield t.call(e,r,n,this)}catch(r){t.callError(e,r,n,this)}})),o&&"string"==typeof r&&this.mode!==u.test&&this.rules.reduce((t,i)=>(i.match(e,r).forEach(e=>{t.add(e)}),t),new Set).forEach(t=>{this.push(t)})})}error(t){const{url:e,error:r,config:i}=t,n=this.config&&this.config.errorMiddleware;n&&n.length&&n.forEach(t=>{t.call(this,e,r,i,this)})}initRules(t){t.forEach(t=>{const e=new o.default(t.name,t.test,t.config,t.parse,t.pipeline,t.error);this.rules.push(e)})}}},function(t,e,r){"use strict";var i=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))(function(n,s){function o(t){try{c(i.next(t))}catch(t){s(t)}}function u(t){try{c(i.throw(t))}catch(t){s(t)}}function c(t){t.done?n(t.value):new r(function(e){e(t.value)}).then(o,u)}c((i=i.apply(t,e||[])).next())})},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=n(r(4)),o=r(5),u=n(r(6)),c=n(r(7));class l extends o.EventEmitter{constructor(t={repeat:!1},e){super(),this.delay=0,this.overlist=new Set,this.maxConnect=1/0,this.connect=0,this.middlewares=[],this.timer=null,this.baseConfig={},this.$system={},this.queue=[];const r=this.baseConfig=Object.assign({},this.baseConfig,t);r.maxConnect&&(this.maxConnect=r.maxConnect,delete r.maxConnect),r.delay&&(this.maxConnect=1,this.delay=r.delay,delete r.delay),r.repeat||(this.middlewares.push(s.default),delete r.repeat),r.$system&&(this.$system=r.$system,delete r.$system),e&&(this.middlewares=[...this.middlewares,...e])}static clone(t){return new l(t.baseConfig,t.middlewares)}ifInsert(){return this.connect<this.maxConnect}push(t,e={},r=!1){return i(this,void 0,void 0,function*(){if(this.ifInsert())return void this.run(t,e);const i=this.queue;r?i.unshift({url:t,config:e}):i.push({url:t,config:e})})}run(t,e={}){return i(this,void 0,void 0,function*(){this.connect++;try{e=Object.assign({jar:!1,encoding:null},this.baseConfig,e);const r=this.callMiddleware(Object.assign({url:t},e,{$system:this.$system}));if(!1===r)throw new Error("middleware return false");const i=yield c.default(t,r),n={url:t,config:e,data:i};if(!e.encoding){const t=e.meta&&e.meta.charset;n.data=this.decode(i,t)}this.emit("complete",n)}catch(r){this.emit("error",{url:t,config:e,error:r})}finally{this.delay?this.timer=setTimeout(()=>{this.timer&&(clearTimeout(this.timer),this.timer=null),this.complete()},this.delay):this.complete()}})}callMiddleware(t){let e=Object.assign({},t);for(const t of this.middlewares)if(!1===(e=t(e)))break;return e}decode(t,e){if(e)return u.default.decode(t,e);const r=u.default.decode(t,"utf8");try{e=(e=/charset\=[^"].*"|charset\="[^"].*"/.exec(r)).replace("charset=","").replace(/"/g,"").replace("-","").trim()}catch(t){e="utf8"}return"utf8"===e.toLowerCase()?r:u.default.decode(t,e)}complete(){for(this.connect--;this.ifInsert();){const t=this.queue.shift();if(!t)break;this.push(t.url,t.config)}}}e.default=l},function(t,e,r){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const n=i(r(3)),s=i(r(1)),o=i(r(0));e.Crawl=n.default,e.Http=s.default,e.Spider=o.default,e.default=e.Crawl},function(t,e,r){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const n=i(r(0));e.default=class{static create(t){return new n.default(t)}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t){let e;return t.$system||(t.$system={}),e=t.$system.overlist?t.$system.overlist:t.$system.overlist=new Set,"string"==typeof t.url&&!e.has(t.url)&&(e.add(t.url),t)}},function(t,e){t.exports=require("events")},function(t,e){t.exports=require("iconv-lite")},function(t,e){t.exports=require("request-promise")},function(t,e,r){"use strict";var i=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))(function(n,s){function o(t){try{c(i.next(t))}catch(t){s(t)}}function u(t){try{c(i.throw(t))}catch(t){s(t)}}function c(t){t.done?n(t.value):new r(function(e){e(t.value)}).then(o,u)}c((i=i.apply(t,e||[])).next())})},n=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e},s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=n(r(9)),u=s(r(10));e.default=class{constructor(t="rule",e,r={baseUrl:""},i,n,s){this.name=t,this.rule=new RegExp(e),this.config=r,this.parse=i,this.pipeline=n,this.error=s}match(t,e){const r=new Set,i=new RegExp(this.rule,"g"),n=e.match(i);return Array.isArray(n)&&n.forEach(e=>{const i=this.config.baseUrl?this.config.baseUrl:t;r.add(u.default.resolve(i,e))}),r}test(t){return this.rule.test(t)}call(t,e,r,n){return i(this,void 0,void 0,function*(){if(!this.test(t))return;if(!this.parse)return;const i=yield this.parse.call(n,t,e,"string"==typeof e?o.load(e):null,r,n);this.pipeline&&(yield this.pipeline.call(n,i,n))})}callError(t,e,r,i){this.error&&this.error.call(i,t,e,r,i)}isInclude(){return!1!==this.config.include}}},function(t,e){t.exports=require("cheerio")},function(t,e){t.exports=require("url")}])});