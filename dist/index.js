!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(global,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(e,t){e.exports=require("tslib")},function(e,t,r){var n,o,i;o=[t,r(13)],void 0===(i="function"==typeof(n=function(e,t){"use strict";var r;Object.defineProperty(e,"__esModule",{value:!0}),e.createLogger=function(e,r){void 0===r&&(r=!0);var n=t.default.getLogger(e);return n.addContext("logName",e),r||(n.level="off"),n},e.default=void 0,(r=t,t=r&&r.__esModule?r:{default:r}).default.configure({appenders:{console:{type:"console"}},categories:{default:{appenders:["console"],level:"info"}}});var n=t.default;e.default=n})?n.apply(t,o):n)||(e.exports=i)},function(e,t,r){var n,o,i;o=[t,r(0),r(3),r(9),r(4),r(14),r(1)],void 0===(i="function"==typeof(n=function(r,n,o,i,u,s,a){"use strict";function c(e){return e&&e.__esModule?e:{default:e}}function l(e){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var f,p;Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0,n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}(n),i=c(i),u=c(u),s=c(s),function(e){e[e.development=0]="development",e[e.production=1]="production",e[e.test=2]="test"}(f||(f={})),function(e){e[e.Running=0]="Running",e[e.Complete=1]="Complete",e[e.Waiting=2]="Waiting"}(p||(p={}));var d=function(e){function t(t,r){var o=e.call(this)||this;return o.config={},o.rules=[],o.status=p.Waiting,o.mode=f.production,o.errorMiddlewares=[],o.config=n.__assign({},o.config,t),o.http=r?u.default.clone(r):new u.default(n.__assign({},t.http,{name:t.name,log:t.log}),t.downloadMiddleware),o.logger=(0,a.createLogger)(t.name||"spider",t.log),o.init(o.config),o}return n.__extends(t,e),t.new=function(e){return new t(e)},t.prototype.init=function(e){e.rules&&this.initRules(e.rules),e.errorMiddleware&&(this.errorMiddlewares=this.errorMiddlewares.concat(e.errorMiddleware)),this.http.on("complete",this.handler.bind(this)),this.http.on("error",this.error.bind(this)),this.http.on("completeAll",this.onCompleteAll.bind(this))},t.prototype.start=function(e,t){return void 0===e&&(e=[]),n.__awaiter(this,void 0,void 0,function(){return n.__generator(this,function(r){switch(r.label){case 0:return this.status=p.Running,this.config.open&&"function"==typeof this.config.open?(this.logger.info("执行打开函数"),[4,this.config.open.call(this,this)]):[3,2];case 1:r.sent(),r.label=2;case 2:return this.push(e,t),[2]}})})},t.prototype.test=function(e,t){this.mode=f.test,this.start(e,t)},t.prototype.push=function(e,t,r){var o=this;void 0===t&&(t={}),void 0===r&&(r=!1);var i=[];"function"==typeof e&&(e=e()),Array.isArray(e)?i=i.concat(e):e instanceof Set?i=i.concat(Array.from(e)):i.push(e),0!==this.http.connect||0!==i.length?i.forEach(function(e){if(e&&"string"==typeof e){o.logger.info("任务推送:"+e);var i=o.getRuleConfig(e),u=i&&i.http||{};o.http.push(e,n.__assign({},u,{rule:i},t),r)}}):this.status=p.Complete},t.prototype.rule=function(e,t,r){for(var n=this,o=[],i=3;i<arguments.length;i++)o[i-3]=arguments[i];var u,a={},c=o[o.length-1];"object"===l(c)&&(a=c,o.pop());var f=new Promise(function(e,t){u=t}),p=new s.default(e,t,a,r,o,function(e,t,r){u(e,t,r,n)});return this.rules.push(p),f},t.prototype.use=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.http.appendMiddleware(e)},t.prototype.handler=function(e){return n.__awaiter(this,void 0,Promise,function(){var t,r,o,i,u,s,a=this;return n.__generator(this,function(c){return t=e.url,r=e.data,o=e.config,this.logger.info("请求完成,等待处理,"+t),i=this.rules.filter(function(e){return e.test(t)}),u=!0,i.forEach(function(e){return n.__awaiter(a,void 0,void 0,function(){var i;return n.__generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),u&&(u=e.isInclude()),this.logger.info("正在进行数据处理:"+t),[4,e.call(t,r,o,this)];case 1:return n.sent(),[3,3];case 2:return i=n.sent(),this.logger.error("数据处理异常,url:"+t+",error:",i),e.callError(t,i,o,this),[3,3];case 3:return[2]}})})}),u&&"string"==typeof r&&this.mode!==f.test?(this.logger.info("正在提取匹配url:"+t),s=this.rules.reduce(function(e,n){var o=n.match(t,r);return o.forEach(function(t){e.add(t)}),e},new Set),this.push(s),[2]):[2]})})},t.prototype.error=function(e){var t=this,r=e.url,n=e.error,o=e.config;this.errorMiddlewares.forEach(function(e){e.call(t,r,n,o,t)})},t.prototype.plan=function(e,t,r){var n=this;void 0===r&&(r=!0),r&&this.start(t),i.default.scheduleJob(e,function(){n.status!==p.Running&&n.start(t)})},t.prototype.onCompleteAll=function(){var e=this;if(this.status=p.Complete,this.logger.info("任务全部完成"),this.config.plan){var t=this.config.plan,r=t.time,n=t.urls;this.logger.info("等待执行计划任务,剩余时间"+r),setTimeout(function(){e.logger.info("执行定时任务"),e.push(n)},r)}else this.config.close&&"function"==typeof this.config.close&&(this.logger.info("执行关闭函数"),this.config.close.call(this,this))},t.prototype.getRuleConfig=function(e){var t=this.rules.reduce(function(t,r){return r.test(e)?n.__assign({},t,r.config):t},{});return t},t.prototype.initRules=function(e){var t=this;e.forEach(function(e){var r=new s.default(e.name,e.test,e.config,e.parse,e.pipeline,e.error);t.rules.push(r)}),this.logger.info("初始化规则,共找到"+this.rules.length+"个")},t}(o.EventEmitter);r.default=d,e.exports=t.default})?n.apply(t,o):n)||(e.exports=i)},function(e,t){e.exports=require("events")},function(e,t,r){var n,o,i;o=[t,r(0),r(3),r(10),r(11),r(12),r(1)],void 0===(i="function"==typeof(n=function(e,t,r,n,o,i,u){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.Http=void 0,t=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}(t),n=s(n),o=s(o),i=s(i);var a=function(e){function r(r,n){void 0===r&&(r={repeat:!1});var o=e.call(this)||this;o.delay=0,o.maxConnect=1/0,o.connect=0,o.middlewares=[],o.timer=null,o.config={overlist:new Set,cacheMap:new Map},o.queue=[],o.logger=(0,u.createLogger)(r.name||"spider",r.log);var s=o.config=t.__assign({},o.config,r);return s.maxConnect&&(o.maxConnect=s.maxConnect,delete s.maxConnect),s.delay&&(o.maxConnect=1,o.delay=s.delay,delete s.delay),s.repeat||(o.middlewares.push(i.default),delete s.repeat),n&&(o.middlewares=o.middlewares.concat(n)),o}return t.__extends(r,e),r.clone=function(e){return new r(e.config,e.middlewares)},r.prototype.request=function(e,r){return t.__awaiter(this,void 0,void 0,function(){return t.__generator(this,function(t){switch(t.label){case 0:return[4,(0,o.default)(e,r)];case 1:return[2,t.sent()]}})})},r.prototype.inspect=function(){return this.connect<this.maxConnect},r.prototype.push=function(e,r,n){return void 0===r&&(r={}),void 0===n&&(n=!1),t.__awaiter(this,void 0,Promise,function(){var o;return t.__generator(this,function(t){return this.inspect()?(this.run(e,r),[2]):(this.logger.info("任务加入队列:"+e),o=this.queue,n?o.unshift({url:e,config:r}):o.push({url:e,config:r}),[2])})})},r.prototype.addOverUrl=function(e){this.config.overlist||(this.config.overlist=new Set),this.config.overlist.add(e)},r.prototype.run=function(e,r){return void 0===r&&(r={}),t.__awaiter(this,void 0,Promise,function(){var n,o,i,u,s,a,c=this;return t.__generator(this,function(l){switch(l.label){case 0:this.connect++,this.logger.info("正在进行请求,目前请求数量:"+this.connect+":url:"+e),n=!1,l.label=1;case 1:return l.trys.push([1,4,5,6]),[4,this.callMiddleware(t.__assign({url:e},this.config,r,{rootConfig:this.config}))];case 2:if(!1===(o=l.sent()))throw this.logger.info("网络处理中间件阻止继续执:"+e),n=!0,new Error("middleware return false");return[4,this.request(e,t.__assign({jar:!1,encoding:null},o))];case 3:i=l.sent(),u={url:e,config:o,data:i},o.encoding||(s=o.charset,u.data=this.decode(i,s));try{"string"==typeof u.data&&/^(\{|\[)/.test(u.data)&&(u.data=JSON.parse(u.data))}catch(e){}return this.logger.info("网络请求完成:"+e),this.emit("complete",u),[3,6];case 4:return"middleware return false"!==(a=l.sent()).message&&r.retry?(this.push(e,t.__assign({},r,{retry:r.retry-1})),this.emit("error-retry",{url:e,config:r,error:a}),[2]):(this.emit("error",{url:e,config:r,error:a}),[3,6]);case 5:return this.delay&&!n?setTimeout(function(){c.logger.info("网络请求等待延迟:"+e+","+c.delay),c.complete()},this.delay):this.complete(),[7];case 6:return[2]}})})},r.prototype.appendMiddleware=function(e){Array.isArray(e)?this.middlewares=this.middlewares.concat(e):this.middlewares.push(e)},r.prototype.callMiddleware=function(e){return t.__awaiter(this,void 0,Promise,function(){var r,n,o,i;return t.__generator(this,function(t){switch(t.label){case 0:r=e,n=0,o=this.middlewares,t.label=1;case 1:return n<o.length?[4,(0,o[n])(r)]:[3,4];case 2:if(i=t.sent())r=i;else if(!1===i)return[2,!1];t.label=3;case 3:return n++,[3,1];case 4:return[2,r]}})})},r.prototype.decode=function(e,t){if(t)return n.default.decode(e,t);var r=n.default.decode(e,"utf8");try{t=(t=/charset\=[^"].*"|charset\="[^"].*"/.exec(r)).replace("charset=","").replace(/"/g,"").replace("-","").trim()}catch(e){t="utf8"}return"utf8"===t.toLowerCase()?r:n.default.decode(e,t)},r.prototype.complete=function(){for(this.connect--;this.inspect();){var e=this.queue.shift();if(!e)break;this.push(e.url,e.config)}0===this.connect&&0===this.queue.length&&this.emit("completeAll")},r}(r.EventEmitter);e.Http=a;var c=a;e.default=c})?n.apply(t,o):n)||(e.exports=i)},function(e,t,r){r(6),e.exports=r(7)},function(e,t){e.exports=require("@babel/polyfill")},function(e,t,r){var n,o,i;o=[t,r(8),r(4),r(2),r(17),r(1)],void 0===(i="function"==typeof(n=function(e,t,r,n,o,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var u={createLogger:!0};Object.defineProperty(e,"default",{enumerable:!0,get:function(){return n.default}}),Object.defineProperty(e,"createLogger",{enumerable:!0,get:function(){return i.createLogger}}),Object.keys(t).forEach(function(r){"default"!==r&&"__esModule"!==r&&(Object.prototype.hasOwnProperty.call(u,r)||Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[r]}}))}),Object.keys(r).forEach(function(t){"default"!==t&&"__esModule"!==t&&(Object.prototype.hasOwnProperty.call(u,t)||Object.defineProperty(e,t,{enumerable:!0,get:function(){return r[t]}}))}),n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}(n),Object.keys(n).forEach(function(t){"default"!==t&&"__esModule"!==t&&(Object.prototype.hasOwnProperty.call(u,t)||Object.defineProperty(e,t,{enumerable:!0,get:function(){return n[t]}}))}),Object.keys(o).forEach(function(t){"default"!==t&&"__esModule"!==t&&(Object.prototype.hasOwnProperty.call(u,t)||Object.defineProperty(e,t,{enumerable:!0,get:function(){return o[t]}}))})})?n.apply(t,o):n)||(e.exports=i)},function(e,t,r){var n,o,i;o=[t,r(2)],void 0===(i="function"==typeof(n=function(e,t){"use strict";var r;Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.Crawl=void 0,t=(r=t)&&r.__esModule?r:{default:r};var n=function(){function e(){}return e.create=function(e){var r=new t.default(e);return r},e}();e.Crawl=n;var o=n;e.default=o})?n.apply(t,o):n)||(e.exports=i)},function(e,t){e.exports=require("node-schedule")},function(e,t){e.exports=require("iconv-lite")},function(e,t){e.exports=require("request-promise")},function(e,t,r){var n,o,i;o=[t,r(0)],void 0===(i="function"==typeof(n=function(r,n){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(e){return n.__awaiter(this,void 0,Promise,function(){var t,r,o,i,u,s,a,c;return n.__generator(this,function(n){return t=e.url,r=e.overlist,o=e.cacheMap,i=e.rule,u=e.rootConfig,s=e.cacheTime,r||(u.overlist=e.overlist=r=new Set),o||(u.cacheMap=e.cacheMap=o=new Map),(a=s||i&&i.cacheTime)?(c=o.get(t))&&Date.now()-c.date>=a?(c.date=Date.now(),[2,e]):c||r.has(t)?[2,!1]:(r.add(t),o.set(t,{date:Date.now()}),[2,e]):r.has(t)?[2,!1]:[2,e]})})},n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}(n),e.exports=t.default})?n.apply(t,o):n)||(e.exports=i)},function(e,t){e.exports=require("log4js")},function(e,t,r){var n,o,i;o=[t,r(0),r(15),r(16)],void 0===(i="function"==typeof(n=function(e,t,r,n){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}var i;Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.Rule=void 0,t=o(t),r=o(r),n=(i=n)&&i.__esModule?i:{default:i};var u=function(){function e(e,t,r,n,o,i){void 0===e&&(e="rule"),void 0===r&&(r={baseUrl:""}),this.pipelines=[],this.name=e,this.rule=new RegExp(t),this.config=r,this.parse=n,o&&(Array.isArray(o)?this.pipelines=this.pipelines.concat(o):this.pipelines.push(o)),this.error=i}return e.prototype.match=function(e,t){var r=this,o=new Set,i=new RegExp(this.rule,"g"),u=t.match(i);return Array.isArray(u)&&u.forEach(function(t){var i=r.config.baseUrl?r.config.baseUrl:e;o.add(n.default.resolve(i,t))}),o},e.prototype.test=function(e){return this.rule.test(e)},e.prototype.call=function(e,n,o,i){return t.__awaiter(this,void 0,Promise,function(){var u,s,a,c;return t.__generator(this,function(t){switch(t.label){case 0:if(!this.test(e))return[2];if(!this.parse)return[2];t.label=1;case 1:return t.trys.push([1,7,,8]),[4,this.parse.call(i,e,n,r.load(n),o,i)];case 2:if(u=t.sent(),!this.pipelines.length)return[2];s=0,a=this.pipelines,t.label=3;case 3:return s<a.length?[4,a[s].call(i,u,i)]:[3,6];case 4:if(!1===(u=t.sent()))return[3,6];t.label=5;case 5:return s++,[3,3];case 6:return[3,8];case 7:return c=t.sent(),this.callError(e,c,o,i),[3,8];case 8:return[2]}})})},e.prototype.callError=function(e,t,r,n){this.error&&this.error.call(n,e,t,r,n)},e.prototype.isInclude=function(){return!1!==this.config.include},e}();e.Rule=u;var s=u;e.default=s})?n.apply(t,o):n)||(e.exports=i)},function(e,t){e.exports=require("cheerio")},function(e,t){e.exports=require("url")},function(e,t,r){var n,o,i;o=[t],void 0===(i="function"==typeof(n=function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.$get=function(e,t,r){void 0===r&&(r=null);var n=t.split("."),o=e;try{for(var i=0,u=n;i<u.length;i++){var s=u[i],a=o[s];if(!a)throw new Error;o=a}return o}catch(e){return r}},e.$call=function(e,t,r){return void 0===r&&(r=null),e&&e[t]&&"function"==typeof e[t]?e[t]():r},e.handlerJSONP=function(e){return e.replace(/\\"/g,'"').replace(/"\{/g,"{").replace(/\}"/g,"}").replace(/"\[/g,"[").replace(/\]"/g,"]"),JSON.parse(e)}})?n.apply(t,o):n)||(e.exports=i)}])});