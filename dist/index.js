!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.spider=t():e.spider=t()}(global,function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=3)}([function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(n,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function u(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(o,u)}c((r=r.apply(e,t||[])).next())})},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(i(1)),o=n(i(8)),u=i(2);var c;!function(e){e[e.development=0]="development",e[e.production=1]="production",e[e.test=2]="test"}(c||(c={}));class l extends u.EventEmitter{constructor(e,t){super(),this.config={name:"spider"},this.rules=[],this.mode=c.production,this.errorMiddlewares=[],this.config=Object.assign({},this.config,e),this.http=t?s.default.clone(t):new s.default(e.http,e.downloadMiddleware),this.init(this.config)}static new(e){return new l(e)}init(e){e.rules&&this.initRules(e.rules),e.errorMiddleware&&(this.errorMiddlewares=this.errorMiddlewares.concat(e.errorMiddleware)),this.http.on("complete",this.handler.bind(this)),this.http.on("error",this.error.bind(this)),this.http.on("completeAll",this.onCompleteAll.bind(this))}start(e,t){return r(this,void 0,void 0,function*(){this.config.open&&"function"==typeof this.config.open&&(yield this.config.open.call(this,this)),this.push(e,t)})}test(e,t){this.mode=c.test,this.start(e,t)}push(e,t={},i=!1){let r=[];Array.isArray(e)?r=r.concat(e):r.push(e),r.forEach(e=>{const r=this.getRuleConfig(e);this.http.push(e,Object.assign({},t,r),i)})}rule(e,t,i,...r){let n={};const s=r[r.length-1];let u;"object"==typeof s&&(n=s,r.pop());const c=new Promise((e,t)=>{u=t}),l=new o.default(e,t,n,i,r,(e,t,i)=>{u(e,t,i,this)});return this.rules.push(l),c}use(...e){this.http.appendMiddleware(e)}handler(e){return r(this,void 0,void 0,function*(){const{url:t,data:i,config:n}=e,s=[];for(const e of this.rules)e.test(t)&&s.push(e);let o=!0;if(s.forEach(e=>r(this,void 0,void 0,function*(){try{o&&(o=e.isInclude()),yield e.call(t,i,n,this)}catch(i){e.callError(t,i,n,this)}})),!o||"string"!=typeof i||this.mode===c.test)return;this.rules.reduce((e,r)=>{return r.match(t,i).forEach(t=>{e.add(t)}),e},new Set).forEach(e=>{this.push(e)})})}error(e){const{url:t,error:i,config:r}=e;this.errorMiddlewares.forEach(e=>{e.call(this,t,i,r,this)})}onCompleteAll(){this.config.close&&"function"==typeof this.config.close&&this.config.close.call(this,this)}getRuleConfig(e){const t=["expire"];return this.rules.reduce((i,r)=>(r.test(e)&&(t.forEach(e=>{r.config[e]&&(i.$rule||(i.$rule={}),i.$rule[e]=r.config[e])}),r.config.http&&(i=Object.assign({},i,r.config.http))),i),{})}initRules(e){e.forEach(e=>{const t=new o.default(e.name,e.test,e.config,e.parse,e.pipeline,e.error);this.rules.push(t)})}}t.default=l},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(n,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function u(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(o,u)}c((r=r.apply(e,t||[])).next())})},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(i(5)),o=i(2),u=n(i(6)),c=n(i(7));class l extends o.EventEmitter{constructor(e={repeat:!1},t){super(),this.delay=0,this.overlist=new Set,this.maxConnect=1/0,this.connect=0,this.middlewares=[],this.timer=null,this.baseConfig={},this.$system={},this.queue=[];const i=this.baseConfig=Object.assign({},this.baseConfig,e);i.maxConnect&&(this.maxConnect=i.maxConnect,delete i.maxConnect),i.delay&&(this.maxConnect=1,this.delay=i.delay,delete i.delay),i.repeat||(this.middlewares.push(s.default),delete i.repeat),i.$system&&(this.$system=i.$system,delete i.$system),t&&(this.middlewares=[...this.middlewares,...t])}static clone(e){return new l(e.baseConfig,e.middlewares)}ifInsert(){return this.connect<this.maxConnect}push(e,t={},i=!1){return r(this,void 0,void 0,function*(){if(this.ifInsert())return void this.run(e,t);const r=this.queue;i?r.unshift({url:e,config:t}):r.push({url:e,config:t})})}run(e,t={}){return r(this,void 0,void 0,function*(){this.connect++;let i=!1;try{let r=Object.assign({jar:!1,encoding:null},this.baseConfig,t);const n=this.$system;if(!1===(r=this.callMiddleware(Object.assign({url:e},t,{$rule:{},$system:n}))))throw i=!0,new Error("middleware return false");delete r.$system,delete r.$rule;const s=yield c.default(e,t),o={url:e,config:Object.assign({},this.baseConfig,r),data:s};if(!t.encoding){const e=t.meta&&t.meta.charset;o.data=this.decode(s,e)}this.emit("complete",o)}catch(i){this.emit("error",{url:e,config:t,error:i})}finally{this.delay&&!i?this.timer=setTimeout(()=>{this.timer&&(clearTimeout(this.timer),this.timer=null),this.complete()},this.delay):this.complete()}})}appendMiddleware(e){Array.isArray(e)?this.middlewares=this.middlewares.concat(e):this.middlewares.push(e)}callMiddleware(e){let t=Object.assign({},e);for(const e of this.middlewares){const i=e(t);if(i)t=i;else if(!1===i)return!1}return t}decode(e,t){if(t)return u.default.decode(e,t);const i=u.default.decode(e,"utf8");try{t=(t=/charset\=[^"].*"|charset\="[^"].*"/.exec(i)).replace("charset=","").replace(/"/g,"").replace("-","").trim()}catch(e){t="utf8"}return"utf8"===t.toLowerCase()?i:u.default.decode(e,t)}complete(){for(this.connect--;this.ifInsert();){const e=this.queue.shift();if(!e)break;this.push(e.url,e.config)}0===this.connect&&0===this.queue.length&&this.emit("completeAll")}}t.default=l},function(e,t){e.exports=require("events")},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=r(i(4)),s=r(i(1)),o=r(i(0));t.Crawl=n.default,t.Http=s.default,t.Spider=o.default,t.default=t.Spider},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=r(i(0));t.default=class{static create(e){return new n.default(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){let t;e.$system||(e.$system={});let i=e.$system.overlist;i&&i instanceof Map?t=i:i.forEach?(t=new Map,i.forEach(e=>{t.set(e,{})})):t=i=new Map;const r=e.url;if("string"!=typeof r)return!1;if(e.$rule&&e.$rule.expire){const i=e.$rule.expire,n=t.get(r);return n&&n.time?n.time+i>Date.now()&&(n.time=Date.now(),e):(t.set(r,{time:Date.now()}),e)}return t.set(r,{}),e}},function(e,t){e.exports=require("iconv-lite")},function(e,t){e.exports=require("request-promise")},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(n,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function u(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(o,u)}c((r=r.apply(e,t||[])).next())})},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(i(9)),u=s(i(10));t.default=class{constructor(e="rule",t,i={baseUrl:""},r,n,s){this.pipelines=[],this.name=e,this.rule=new RegExp(t),this.config=i,this.parse=r,n&&(Array.isArray(n)?this.pipelines=this.pipelines.concat(n):this.pipelines.push(n)),this.error=s}match(e,t){const i=new Set,r=new RegExp(this.rule,"g"),n=t.match(r);return Array.isArray(n)&&n.forEach(t=>{const r=this.config.baseUrl?this.config.baseUrl:e;i.add(u.default.resolve(r,t))}),i}test(e){return this.rule.test(e)}call(e,t,i,n){return r(this,void 0,void 0,function*(){if(this.test(e)&&this.parse)try{let r=yield this.parse.call(n,e,t,"string"==typeof t?o.load(t):null,i,n);if(!this.pipelines.length)return;for(const e of this.pipelines)if(!1===(r=yield e.call(n,r,n)))break}catch(t){this.callError(e,t,i,n)}})}callError(e,t,i,r){this.error&&this.error.call(r,e,t,i,r)}isInclude(){return!1!==this.config.include}}},function(e,t){e.exports=require("cheerio")},function(e,t){e.exports=require("url")}])});